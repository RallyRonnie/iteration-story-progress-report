<!DOCTYPE html>
<html>
<head>
    <title>iterationstoryprogressreport</title>

<script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/sdk-debug.js"></script>
<script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:[{xtype:"container",layout:{type:"table",columns:2},items:[{xtype:"container",itemId:"iterationDropDown",columnWidth:2},{xtype:"rallycheckboxfield",itemId:"flatCheckBox",fieldLabel:'Show only "Flat"',columnWidth:1,value:!1}]},{xtype:"container",itemId:"chart1",columnWidth:1}],addIterationDropDown:function(){var timeboxScope=this.getContext().getTimeboxScope();if(timeboxScope){var record=timeboxScope.getRecord(),name=record.get("Name");this.gIteration=record.data,this._onIterationSelect()}else this.down("#iterationDropDown").add({xtype:"rallyiterationcombobox",itemId:"iterationSelector",listeners:{select:this._onIterationSelect,ready:this._onIterationSelect,scope:this}})},_onIterationSelect:function(){if(_.isUndefined(this.getContext().getTimeboxScope())){var value=this.down("#iterationSelector").getRecord();this.gIteration=value.data}var iterationId=this.gIteration.ObjectID;Ext.create("Rally.data.lookback.SnapshotStore",{autoLoad:!0,limit:1/0,listeners:{load:this._onIterationSnapShotData,scope:this},fetch:["ObjectID","Name","Priority","ScheduleState","PlanEstimate","TaskEstimateTotal","TaskRemainingTotal","_UnformattedID","Blocked"],hydrate:["ScheduleState"],filters:[{property:"_TypeHierarchy",operator:"in",value:["Defect","HierarchicalRequirement"]},{property:"Iteration",operator:"in",value:iterationId}]})},_onIterationSnapShotData:function(store,data,success){var lumenize=window.parent.Rally.data.lookback.Lumenize,snapShotData=_.map(data,function(d){return d.data}),metrics=[],metricsAfterSummary=[],hcConfig=[{name:"label"}];_.each(_.uniq(snapShotData,function(e){return e._UnformattedID}),function(item){var id=item._UnformattedID,metric1={as:"S"+(""+id)+"Remaining",f:"filteredSum",field:"TaskRemainingTotal",filterField:"_UnformattedID",filterValues:[id]},metric2={as:"S"+(""+id)+"Total",f:"filteredSum",field:"TaskEstimateTotal",filterField:"_UnformattedID",filterValues:[id]},summary={as:"S"+(""+id),f:function(row,index,summaryMetrics,seriesData){var t=row["S"+(""+id)+"Total"],r=row["S"+(""+id)+"Remaining"];return t>0?100*((t-r)/t):0}};metricsAfterSummary.push(summary),metrics.push(metric1),metrics.push(metric2);var hc={name:"S"+(""+id),comment:item.Name};1==item.Blocked&&(hc.dashStyle="ShortDot"),hcConfig.push(hc)});var config={deriveFieldsOnInput:[],metrics:metrics,summaryMetricsConfig:[],deriveFieldsAfterSummary:metricsAfterSummary,granularity:lumenize.Time.DAY,tz:"America/New_York",holidays:[],workDays:"Monday,Tuesday,Wednesday,Thursday,Friday"},startOnISOString=new lumenize.Time(this.gIteration.StartDate).getISOStringInTZ(config.tz),upToDateISOString=new lumenize.Time(this.gIteration.EndDate).getISOStringInTZ(config.tz);calculator=new lumenize.TimeSeriesCalculator(config),calculator.addSnapshots(snapShotData,startOnISOString,upToDateISOString);var hc=lumenize.arrayOfMaps_To_HighChartsSeries(calculator.getResults().seriesData,hcConfig);this.ghc=hc,this._showChart(hc)},isFlat:function(series,todayIndex){var flat=!1;return-1!=todayIndex&&todayIndex>=2&&0!=series.data[todayIndex]&&100!=series.data[todayIndex]&&series.data[todayIndex]==series.data[todayIndex-1]&&series.data[todayIndex]==series.data[todayIndex-2]&&(flat=!0),flat},_showChart:function(){var that=this,series=this.ghc,chart=this.down("#chart1");chart.removeAll();var flat=this.down("#flatCheckBox").getValue();series[1].data=_.map(series[1].data,function(d){return _.isNull(d)?0:d});var today=new Date,todayIndex=-1;_.each(series[0].data,function(x,i){var dt=new Date(Date.parse(x));-1==todayIndex&&dt>today&&(todayIndex=i)}),_.each(series,function(s,i){i>0&&(s.data=_.map(s.data,function(d,x){return todayIndex>0&&x>todayIndex?null:d}))});var newSeries=[];newSeries=flat?_.filter(series.slice(1,series.length),function(s){return that.isFlat(s,todayIndex)}):series.slice(1,series.length);var extChart=Ext.create("Rally.ui.chart.Chart",{chartData:{categories:series[0].data,series:newSeries},chartConfig:{chart:{},title:{text:"",x:-20},tooltip:{formatter:function(){return this.series.name+":"+this.series.options.comment+"<br> The value for <b>"+this.x+"</b> is <b>"+Math.round(this.y)+"</b>"}},legend:{align:"center",verticalAlign:"bottom"},plotOptions:{line:{zIndex:1,tooltip:{valueSuffix:" Percent"}}},yAxis:{min:0,max:100,title:{text:"% Complete by Task Hours"},plotLines:[{value:0,width:1,color:"#808080"}]}}});chart.add(extChart);var p=Ext.get(chart.id),elems=p.query("div.x-mask");_.each(elems,function(e){e.remove()});var elems=p.query("div.x-mask-msg");_.each(elems,function(e){e.remove()})},launch:function(){var that=this;this.addIterationDropDown(),this.down("#flatCheckBox").on("change",function(){that._showChart()})}});

            Rally.launchApp('CustomApp', {
                name:"iterationstoryprogressreport",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
